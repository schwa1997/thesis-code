<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .input-container {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            min-height: 300px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        #imagePreview {
            margin: 10px 0;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #preview {
            max-width: 300px;
            max-height: 200px;
            object-fit: contain;
        }

        .result-item {
            margin: 10px 0;
            padding: 5px;
        }

        .probability-bar {
            margin: 5px 0;
            padding: 3px;
            background-color: #eee;
            border-radius: 3px;
        }

        .probability-value {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 2px;
            text-align: right;
            padding-right: 5px;
            color: white;
            line-height: 20px;
            font-size: 12px;
            transition: width 0.3s ease;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>Model Test Interface</h1>
    <div class="input-container">
        <h3>Upload Image for Testing:</h3>
        <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)">
        <div id="imagePreview">
            <img id="preview" style="display: none;">
        </div>
        <button onclick="runTest()" id="testButton">Run Test</button>
    </div>
    <div>
        <h3>Test Results:</h3>
        <div id="result"></div>
    </div>

    <script>
        let lastResult = null;
        let isProcessing = false;

        function previewImage(event) {
            const preview = document.getElementById('preview');
            const testButton = document.getElementById('testButton');
            preview.style.display = 'block';
            preview.src = URL.createObjectURL(event.target.files[0]);
            testButton.disabled = false;
        }

        async function displayResult(result) {
            const resultDiv = document.getElementById('result');
            if (!result) return;

            const correctnessColor = result.isCorrect ? 'green' : 'red';
            let probabilitiesHtml = '<h4>Prediction Probabilities for All Classes:</h4>';

            const sortedProbabilities = Object.entries(result.allProbabilities)
                .sort(([, a], [, b]) => b - a);

            for (const [vowel, prob] of sortedProbabilities) {
                const percentage = (prob * 100).toFixed(2);
                probabilitiesHtml += `
                    <div class="probability-bar">
                        <div class="probability-value" style="width: ${percentage}%">
                            ${vowel}: ${percentage}%
                        </div>
                    </div>`;
            }

            const resultHtml = `
                <div class="result-item">
                    <p><strong>Prediction:</strong> Class ${result.prediction} (Vowel: ${result.predictedVowel})</p>
                    <p><strong>Actual Vowel:</strong> ${result.actualVowel}</p>
                    <p style="color: ${correctnessColor}"><strong>Status:</strong> Prediction is ${result.isCorrect ? 'correct' : 'incorrect'}</p>
                    <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(2)}%</p>
                </div>
                ${probabilitiesHtml}
            `;

            // 使用 requestAnimationFrame 确保 DOM 更新
            requestAnimationFrame(() => {
                resultDiv.innerHTML = resultHtml;
            });
        }

        async function runTest() {
            if (isProcessing) return;

            const imageInput = document.getElementById('imageInput');
            const resultDiv = document.getElementById('result');
            const testButton = document.getElementById('testButton');

            if (!imageInput.files || !imageInput.files[0]) {
                resultDiv.innerHTML = '<p style="color: red;">Please select an image first</p>';
                return;
            }

            try {
                isProcessing = true;
                testButton.disabled = true;
                resultDiv.innerHTML = '<p>Processing... Please wait...</p>';
                const file = imageInput.files[0];

                if (file.size > 5 * 1024 * 1024) {
                    throw new Error('File is too large. Please select an image under 5MB.');
                }

                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('File reading failed'));
                    reader.readAsDataURL(file);
                });

                console.log('Sending request to server...');
                const response = await fetch('http://localhost:5000/api/test-model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input: base64Image,
                        fileName: file.name
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                console.log('Response received from server');
                const result = await response.json();

                if (result.success) {
                    lastResult = result;
                    await displayResult(result);
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            } finally {
                isProcessing = false;
                testButton.disabled = false;
            }
        }

        // 添加页面卸载前的确认
        window.onbeforeunload = function () {
            if (lastResult) {
                return "Are you sure you want to leave? Your test results will be lost.";
            }
        };

        // 防止意外刷新
        document.addEventListener('keydown', function (e) {
            if ((e.key === 'r' || e.key === 'R') && (e.ctrlKey || e.metaKey)) {
                if (lastResult) {
                    e.preventDefault();
                    if (confirm("Are you sure you want to refresh? Your test results will be lost.")) {
                        window.location.reload();
                    }
                }
            }
        });
    </script>
</body>

</html>